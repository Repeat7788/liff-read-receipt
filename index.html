<!doctype html><html lang="zh-Hant"><meta charset="utf-8">
<title>回條</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<body style="font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif">
<div id="msg" style="padding:24px">處理中...</div>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(async () => {
  const LIFF_ID = "2007725227-Zdr3nr5j";
  const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/nb5p39bk9q6pmmfabfyuoy5s8shueldf";

  const qs = new URL(location.href).searchParams;
  const token = qs.get("t") || "";

  await liff.init({ liffId: LIFF_ID });

  // 檢查並確保 token 新鮮（過期就強制重登，但只做一次避免循環）
  const needRelogin = () => {
    const dec = liff.getDecodedIDToken && liff.getDecodedIDToken();
    if (!dec) return true;                           // 沒 token
    const now = Math.floor(Date.now() / 1000);
    return dec.exp && dec.exp <= now + 30;           // 30秒內將過期也當過期
  };

  if (!liff.isLoggedIn() || needRelogin()) {
    if (!sessionStorage.getItem("relogin_once")) {
      sessionStorage.setItem("relogin_once", "1");
      liff.logout(); // 確保一定換到新 token
      liff.login({ scope: "openid profile email", prompt: "login" });
      return; // 重新導回本頁
    }
  }

  await liff.ready;

  const profile = await liff.getProfile();
  const idToken = liff.getIDToken();
  const decoded = liff.getDecodedIDToken && liff.getDecodedIDToken();

  const payload = {
    t: token,
    time: new Date().toISOString(),
    userId: profile.userId,
    displayName: profile.displayName,
    idToken,
    emailFromDecoded: decoded && decoded.email ? decoded.email : null
  };

  await fetch(MAKE_WEBHOOK_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  document.getElementById("msg").innerText = "✅ 已確認讀取回條，謝謝！";
})();
</script>
</body></html>
